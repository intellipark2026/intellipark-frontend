<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Exit Kiosk</title>
  <script src="https://unpkg.com/html5-qrcode"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      height: 100vh; background: linear-gradient(135deg, #000, #fff);
      display: flex; justify-content: center; align-items: center;
      font-family: sans-serif; color: #fff;
    }
    .kiosk {
      background: rgba(0,0,0,0.9); width: 90%; max-width: 1000px; height: 600px;
      border-radius: 25px; display: flex; overflow: hidden;
    }
    .left {
      flex: 1; background: #fff; color: #000; display: flex;
      flex-direction: column; justify-content: center; padding-left: 60px;
    }
    .left h1 { font-size: 80px; line-height: 1.1; font-weight: 700; }
    .right {
      flex: 1.5; display: flex; flex-direction: column;
      align-items: center; justify-content: center; padding: 20px;
    }
    #reader { 
      width: 350px; height: 350px; border: 4px solid #fff; 
      border-radius: 20px; overflow: hidden; position: relative; background: #000;
    }
    #reader video { 
      width: 100% !important; height: 100% !important;
      object-fit: cover !important; transform: scaleX(-1) !important;
      position: absolute !important; top: 0 !important; left: 0 !important;
    }
    #reader > div:first-child {
      width: 100% !important; height: 100% !important;
    }
    #reader__scan_region {
      width: 100% !important; height: 100% !important;
    }
    #reader__dashboard_section, #reader__dashboard_section_csr {
      display: none !important;
    }

    .text {
      margin-top: 25px; background: #fff; color: #000;
      padding: 12px 40px; border-radius: 50px; font-weight: 600;
    }
    .box { display: none; padding: 30px; border-radius: 15px; text-align: center; margin-top: 30px; width: 90%; }
    .success { background: rgba(0,200,83,0.2); border: 3px solid #0c3; }
    .success h2 { font-size: 48px; color: #0f6; margin: 0; }
    .error { background: rgba(255,77,77,0.2); border: 2px solid #f44; }
    .loading { background: rgba(255,255,255,0.1); }
    .spin {
      border: 4px solid rgba(255,255,255,0.3); border-top: 4px solid #fff;
      border-radius: 50%; width: 50px; height: 50px;
      animation: spin 1s linear infinite; margin: 20px auto;
    }
    @keyframes spin { 100% { transform: rotate(360deg); } }

    .manual-exit-btn {
      margin-top: 15px;
      padding: 12px 28px;
      background: rgba(255,204,0,0.2);
      color: #ffcc00;
      border: 2px solid #ffcc00;
      border-radius: 12px;
      font-size: 20px;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.3s ease;
      backdrop-filter: blur(10px);
      box-shadow: 0 4px 15px rgba(255,204,0,0.2);
    }
    .manual-exit-btn:hover {
      background: rgba(255,204,0,0.3);
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(255,204,0,0.4);
    }
    .manual-modal {
      display: none;
      position: fixed;
      top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.9);
      z-index: 1000;
      justify-content: center; align-items: center;
    }
    .manual-modal.active {
      display: flex;
    }
    .manual-form {
      background: rgba(30,30,30,0.95);
      padding: 40px;
      border-radius: 20px;
      width: 90%;
      max-width: 450px;
      border: 2px solid rgba(255,204,0,0.5);
      box-shadow: 0 10px 40px rgba(0,0,0,0.8);
      color: white;
    }
    .manual-form h2 {
      color: #ffcc00;
      margin-bottom: 15px;
      text-align: center;
      font-size: 3vh;
    }
    .manual-form p {
      color: #aaa;
      font-size: 16px;
      text-align: center;
      margin-bottom: 25px;
    }
    .manual-form input {
      width: 100%;
      padding: 18px;
      margin-bottom: 15px;
      border-radius: 12px;
      border: 2px solid rgba(255,204,0,0.3);
      background: rgba(255,255,255,0.1);
      color: #fff;
      font-size: 32px;
      font-family: 'Courier New', monospace;
      letter-spacing: 4px;
      text-align: center;
      text-transform: uppercase;
      font-weight: bold;
    }
    .manual-form input::placeholder {
      color: rgba(255,255,255,0.4);
      font-size: 16px;
      letter-spacing: normal;
    }
    .manual-form input:focus {
      outline: none;
      border-color: #ffcc00;
      background: rgba(255,255,255,0.15);
      box-shadow: 0 0 20px rgba(255,204,0,0.3);
    }
    .manual-form button {
      width: 100%;
      padding: 16px;
      margin-bottom: 10px;
      border: none;
      border-radius: 12px;
      font-size: 18px;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.3s;
    }
    .btn-exit {
      background: rgba(0,255,153,0.2);
      color: #00ff99;
      border: 2px solid #00ff99;
    }
    .btn-exit:hover {
      background: rgba(0,255,153,0.3);
      transform: translateY(-2px);
    }
    .btn-cancel {
      background: rgba(255,77,77,0.2);
      color: #ff4d4d;
      border: 2px solid #ff4d4d;
    }
    .btn-cancel:hover {
      background: rgba(255,77,77,0.3);
    }
    .manual-form .hint {
      font-size: 13px;
      color: #888;
      text-align: center;
      margin-top: 15px;
    }

    /* Virtual Keyboard - MATCHED SIZE FROM ENTRANCE KIOSK */
    .virtual-keyboard {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: rgba(20,20,20,0.98);
      padding: 15px;
      border-top: 2px solid rgba(255,204,0,0.5);
      z-index: 2000;
      display: none;
      box-shadow: 0 -5px 30px rgba(0,0,0,0.8);
    }
    .virtual-keyboard.active {
      display: block;
    }
    .keyboard-row {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin-bottom: 10px;
    }
    .key {
      background: rgba(255,255,255,0.1);
      border: 2px solid rgba(255,255,255,0.3);
      color: white;
      padding: 20px 24px;
      min-width: 70px;
      border-radius: 10px;
      font-size: 24px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.2s;
      user-select: none;
      font-family: 'Courier New', monospace;
    }
    .key:active {
      background: rgba(255,204,0,0.4);
      border-color: #ffcc00;
      transform: scale(0.95);
    }
    .key.number {
      background: rgba(0,150,255,0.2);
      border-color: rgba(0,150,255,0.4);
    }
    .key.number:active {
      background: rgba(0,150,255,0.5);
    }
    .key.backspace {
      background: rgba(255,77,77,0.2);
      border-color: rgba(255,77,77,0.4);
      min-width: 140px;
      font-size: 20px;
    }
    .key.backspace:active {
      background: rgba(255,77,77,0.5);
    }
    .key.close-keyboard {
      background: rgba(0,255,153,0.2);
      border-color: rgba(0,255,153,0.4);
      min-width: 160px;
      font-size: 20px;
    }
    .key.close-keyboard:active {
      background: rgba(0,255,153,0.5);
    }
  </style>
</head>
<body>
  <div class="kiosk">
    <div class="left">
      <h1>Intelli<br>Park</h1>
    </div>
    <div class="right">
      <div id="reader"></div>
      <div class="text">SCAN QR TO EXIT</div>
      <button class="manual-exit-btn" onclick="event.stopPropagation(); showManualExit();">
        üîë Manual Exit (No QR?)
      </button>
      <div class="box loading" id="loading">
        <div class="spin"></div>
        <p>Verifying ticket...</p>
      </div>
      <div class="box success" id="success">
        <h2>‚úÖ GATE OPEN</h2>
        <p style="font-size:20px; margin-top:10px;">Drive safely!</p>
        <p id="countdown" style="font-size:24px; margin-top:20px;"></p>
      </div>
      <div class="box error" id="error">
        <h3>‚ùå Error</h3>
        <p id="errMsg"></p>
      </div>
    </div>
  </div>

  <div class="manual-modal" id="manualExitModal" onclick="event.stopPropagation();">
    <div class="manual-form" onclick="event.stopPropagation();">
      <h2>üîê Manual Exit</h2>
      <p>Enter your vehicle plate number</p>
      <input type="text" 
             id="exitPlateNumber" 
             placeholder="Plate Number (e.g., ABC123)" 
             maxlength="7"
             onclick="event.stopPropagation();">
      <button onclick="processManualExit()" class="btn-exit">
        ‚úÖ Exit Vehicle
      </button>
      <button onclick="hideManualExit()" class="btn-cancel">
        ‚ùå Cancel
      </button>
      <p class="hint">Must match the plate number on your ticket</p>
    </div>
  </div>

  <!-- Virtual Keyboard - MATCHED SIZE -->
  <div class="virtual-keyboard" id="virtualKeyboard">
    <div class="keyboard-row">
      <div class="key" onclick="addChar('A')">A</div>
      <div class="key" onclick="addChar('B')">B</div>
      <div class="key" onclick="addChar('C')">C</div>
      <div class="key" onclick="addChar('D')">D</div>
      <div class="key" onclick="addChar('E')">E</div>
      <div class="key" onclick="addChar('F')">F</div>
      <div class="key" onclick="addChar('G')">G</div>
    </div>
    <div class="keyboard-row">
      <div class="key" onclick="addChar('H')">H</div>
      <div class="key" onclick="addChar('I')">I</div>
      <div class="key" onclick="addChar('J')">J</div>
      <div class="key" onclick="addChar('K')">K</div>
      <div class="key" onclick="addChar('L')">L</div>
      <div class="key" onclick="addChar('M')">M</div>
      <div class="key" onclick="addChar('N')">N</div>
    </div>
    <div class="keyboard-row">
      <div class="key" onclick="addChar('O')">O</div>
      <div class="key" onclick="addChar('P')">P</div>
      <div class="key" onclick="addChar('Q')">Q</div>
      <div class="key" onclick="addChar('R')">R</div>
      <div class="key" onclick="addChar('S')">S</div>
      <div class="key" onclick="addChar('T')">T</div>
    </div>
    <div class="keyboard-row">
      <div class="key" onclick="addChar('U')">U</div>
      <div class="key" onclick="addChar('V')">V</div>
      <div class="key" onclick="addChar('W')">W</div>
      <div class="key" onclick="addChar('X')">X</div>
      <div class="key" onclick="addChar('Y')">Y</div>
      <div class="key" onclick="addChar('Z')">Z</div>
    </div>
    <div class="keyboard-row">
      <div class="key number" onclick="addChar('0')">0</div>
      <div class="key number" onclick="addChar('1')">1</div>
      <div class="key number" onclick="addChar('2')">2</div>
      <div class="key number" onclick="addChar('3')">3</div>
      <div class="key number" onclick="addChar('4')">4</div>
      <div class="key number" onclick="addChar('5')">5</div>
    </div>
    <div class="keyboard-row">
      <div class="key number" onclick="addChar('6')">6</div>
      <div class="key number" onclick="addChar('7')">7</div>
      <div class="key number" onclick="addChar('8')">8</div>
      <div class="key number" onclick="addChar('9')">9</div>
      <div class="key backspace" onclick="backspace()">‚å´ DELETE</div>
    </div>
    <div class="keyboard-row">
      <div class="key close-keyboard" onclick="closeKeyboard()">‚úì DONE</div>
    </div>
  </div>

  <script>
    const BACKEND = 'https://intellipark-backend-ar00.onrender.com';
    const validSlots = ['slot01', 'slot02', 'slot03', 'slot04', 'slot05', 
                        'slot06', 'slot07', 'slot08', 'slot09', 'slot10'];
    const firebaseConfig = {
      apiKey: "AIzaSyAuH0ng67kSk0arMNOxujgIpnBVr0pwNWE",
      authDomain: "intellipark2025-327e9.firebaseapp.com",
      databaseURL: "https://intellipark2025-327e9-default-rtdb.firebaseio.com",
      projectId: "intellipark2025-327e9",
      storageBucket: "intellipark2025-327e9.appspot.com",
      messagingSenderId: "126333727252",
      appId: "1:126333727252:web:ffa87b61f5e7b3a2122d01"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let scanning = true;
    let activeInput = null;
    const reader = new Html5Qrcode("reader");

    // Virtual Keyboard Functions
    document.addEventListener('DOMContentLoaded', function() {
      const plateInput = document.getElementById('exitPlateNumber');
      
      if (plateInput) {
        plateInput.addEventListener('focus', function() {
          activeInput = this;
          document.getElementById('virtualKeyboard').classList.add('active');
        });
        
        plateInput.setAttribute('readonly', 'readonly');
        plateInput.addEventListener('click', function() {
          this.removeAttribute('readonly');
          activeInput = this;
          document.getElementById('virtualKeyboard').classList.add('active');
          setTimeout(() => {
            this.setAttribute('readonly', 'readonly');
          }, 100);
        });
      }
    });

    function addChar(char) {
      if (!activeInput) return;
      
      const currentValue = activeInput.value;
      const maxLength = parseInt(activeInput.getAttribute('maxlength')) || 999;
      
      if (currentValue.length < maxLength) {
        activeInput.value = currentValue + char;
        activeInput.dispatchEvent(new Event('input'));
      }
    }

    function backspace() {
      if (!activeInput) return;
      activeInput.value = activeInput.value.slice(0, -1);
      activeInput.dispatchEvent(new Event('input'));
    }

    function closeKeyboard() {
      document.getElementById('virtualKeyboard').classList.remove('active');
      activeInput = null;
    }

    function showManualExit() {
      document.getElementById('manualExitModal').classList.add('active');
    }

    function hideManualExit() {
      document.getElementById('manualExitModal').classList.remove('active');
      document.getElementById('exitPlateNumber').value = '';
      closeKeyboard();
    }

    // Manual exit by plate
    async function processManualExit() {
      const plate = document.getElementById('exitPlateNumber').value.trim().toUpperCase();
      if (!plate || plate.length < 3) {
        alert('Please enter a valid plate number.');
        return;
      }
      hideManualExit();
      scanning = false;
      document.getElementById('loading').style.display = 'block';
      try {
        const ticketsSnapshot = await db.ref('/tickets').once('value');
        const tickets = ticketsSnapshot.val() || {};
        let matchedTicketId = null;
        let matchedTicket = null;
        for (const [tid, ticket] of Object.entries(tickets)) {
          if (
            ticket.plate && ticket.plate.trim().toUpperCase() === plate &&
            ticket.status === 'Paid' &&
            !ticket.exitVerified
          ) {
            matchedTicket = ticket;
            matchedTicketId = tid;
            break;
          }
        }
        if (!matchedTicket) {
          throw new Error('No active ticket found for this plate');
        }
        if (matchedTicket.exitVerified) {
          throw new Error('Ticket already used for exit');
        }
        const response = await fetch(`${BACKEND}/api/exit`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            slot: matchedTicket.slot,
            plate: plate,
            exitTime: new Date().toISOString(),
            ticketId: matchedTicketId
          })
        });
        if (!response.ok) {
          const err = await response.json();
          throw new Error(err.error || 'Backend error while exiting');
        }
        const result = await response.json();
        await db.ref(`/tickets/${matchedTicketId}`).update({
          exitVerified: true,
          exitTime: new Date().toISOString()
        });
        await db.ref(`/slots/${matchedTicket.slot}/status`).set('available');
        await db.ref('/gateControl').set({
          status: 'open',
          plate: plate,
          slot: matchedTicket.slot,
          ticketId: matchedTicketId,
          openedAt: new Date().toISOString()
        });
        document.getElementById('loading').style.display = 'none';
        document.getElementById('success').style.display = 'block';
        let count = 10;
        const interval = setInterval(() => {
          document.getElementById('countdown').textContent = `Closing in ${count--}s`;
          if (count < 0) {
            clearInterval(interval);
            db.ref('/gateControl').set({
              status: 'closed',
              plate: plate,
              slot: matchedTicket.slot,
              closedAt: new Date().toISOString(),
              reason: 'auto-close'
            });
            location.reload();
          }
        }, 1000);
      } catch (error) {
        document.getElementById('loading').style.display = 'none';
        document.getElementById('error').style.display = 'block';
        document.getElementById('errMsg').textContent = error.message;
        setTimeout(() => {
          document.getElementById('error').style.display = 'none';
          scanning = true;
        }, 7000);
      }
    }

    // QR exit logic
    async function processQR(qrData) {
      if (!scanning) return;
      scanning = false;
      try {
        let ticketId, slot, plate, qrType;
        if (qrData.includes('verify?')) {
          const url = new URL(qrData);
          ticketId = url.searchParams.get('ticketId');
          slot = url.searchParams.get('slot');
          plate = url.searchParams.get('plate');
          qrType = url.searchParams.get('type');
        } else if (qrData.includes('|')) {
          const parts = qrData.split('|');
          if (parts.length < 3) throw new Error('Invalid QR format');
          [ticketId, slot, plate] = parts;
          qrType = null;
        } else {
          throw new Error('Unsupported QR format');
        }
        if (!ticketId || !slot || !plate) {
          throw new Error('Missing required data');
        }
        if (!validSlots.includes(slot)) {
          throw new Error(`Invalid slot: ${slot}`);
        }
        document.getElementById('loading').style.display = 'block';
        const ticketSnapshot = await db.ref(`/tickets/${ticketId}`).once('value');
        if (!ticketSnapshot.exists()) {
          throw new Error('Invalid ticket');
        }
        const ticketData = ticketSnapshot.val();
        if (ticketData.exitVerified) {
          throw new Error('Ticket already used for exit');
        }
        const ticketType = ticketData.type || qrType;
        let canExit = false;
        if (ticketType === 'walkin') {
          if (ticketData.status === 'Paid') canExit = true;
        } else if (ticketType === 'reservation') {
          if (ticketData.status === 'Paid' && ticketData.entryVerified === true) canExit = true;
        } else {
          if (ticketData.status === 'Paid' && !ticketData.exitVerified) canExit = true;
        }
        if (!canExit) {
          if (ticketData.type === 'reservation') {
            if (!ticketData.entryVerified) {
              throw new Error('Please check in at entrance first');
            }
          } else if (ticketData.type === 'walkin') {
            if (ticketData.status !== 'Paid') {
              throw new Error('Payment required before exit');
            }
          }
        }
        if (ticketData.slot !== slot) {
          throw new Error('Slot mismatch');
        }
        if (ticketData.plate.trim().toUpperCase() !== plate.trim().toUpperCase()) {
          throw new Error('Plate mismatch');
        }
        const response = await fetch(`${BACKEND}/api/exit`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            slot,
            plate,
            exitTime: new Date().toISOString(),
            ticketId
          })
        });
        if (!response.ok) {
          const err = await response.json();
          throw new Error(err.error || 'Backend error');
        }
        const result = await response.json();
        await db.ref(`/tickets/${ticketId}`).update({
          exitVerified: true,
          exitTime: new Date().toISOString()
        });
        await db.ref(`/slots/${slot}/status`).set('available');
        document.getElementById('loading').style.display = 'none';
        document.getElementById('success').style.display = 'block';
        let count = 10;
        const interval = setInterval(() => {
          document.getElementById('countdown').textContent = `Closing in ${count--}s`;
          if (count < 0) {
            clearInterval(interval);
            location.reload();
          }
        }, 1000);
      } catch (error) {
        document.getElementById('loading').style.display = 'none';
        document.getElementById('error').style.display = 'block';
        document.getElementById('errMsg').textContent = error.message;
        setTimeout(() => location.reload(), 7000);
      }
    }

    reader.start(
      { facingMode: "user" },
      {
        fps: 30,
        qrbox: { width: 300, height: 300 },
        aspectRatio: 1.0
      },
      (decodedText) => {
        if (scanning) {
          reader.stop().then(() => processQR(decodedText));
        }
      },
      () => {}
    ).catch(err => {});
  </script>
</body>
</html>
