<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - INTELLIPARK</title>
    
    <!-- PDF Export Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', sans-serif;
        }

        body {
            background: linear-gradient(135deg, #000000, #1b1a1a);
            min-height: 100vh;
            color: #fff;
        }

        .navbar {
            background: rgba(0,0,0,0.5);
            backdrop-filter: blur(10px);
            color: white;
            padding: 15px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 1000;
            border-radius: 0 0 15px 15px;
            box-shadow: 0 4px 30px rgba(0,0,0,0.5);
        }

        .navbar a {
            color: white;
            text-decoration: none;
            display: flex;
            align-items: center;
        }

        .navbar img {
            height: 40px;
            margin-right: 10px;
        }

        .container {
            max-width: 1600px;
            margin: 20px auto;
            padding: 0 20px;
        }

        h1 {
            color: #fff;
            margin-bottom: 20px;
            font-size: 32px;
            text-shadow: 0 2px 5px rgba(0,0,0,0.5);
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.2);
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.2);
            text-align: center;
            transition: transform 0.3s, background 0.3s;
            backdrop-filter: blur(8px);
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 40px rgba(0,0,0,0.3);
            background: rgba(255,255,255,0.1);
        }

        .stat-number {
            font-size: 36px;
            font-weight: bold;
            color: #fff;
            margin: 10px 0;
            text-shadow: 0 2px 5px rgba(0,0,0,0.5);
        }

        .stat-label {
            color: rgba(255,255,255,0.7);
            font-size: 14px;
            text-transform: uppercase;
        }

        .section {
            background: rgba(0,0,0,0.4);
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
            margin-bottom: 20px;
            backdrop-filter: blur(8px);
            border: 1px solid rgba(255,255,255,0.1);
        }

        .section-title {
            font-size: 22px;
            color: #fff;
            margin-bottom: 15px;
            border-bottom: 1px solid rgba(255,255,255,0.2);
            padding-bottom: 10px;
        }

        .slots-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .slot-card {
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            font-weight: bold;
            color: #fff;
            position: relative;
            background: rgba(255,255,255,0.05);
            backdrop-filter: blur(8px);
            border: 1px solid rgba(255,255,255,0.15);
            transition: 0.3s;
        }

        .slot-card:hover {
            transform: translateY(-3px);
            background: rgba(255,255,255,0.08);
        }

        .slot-available {
            background: rgba(0,255,153,0.2);
            color: #00ff99;
        }

        .slot-reserved {
            background: rgba(0,191,255,0.2);
            color: #00bfff;
        }

        .slot-occupied {
            background: rgba(255,77,77,0.2);
            color: #ff4d4d;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            color: #fff;
            font-size: 13px;
        }

        th, td {
            padding: 12px 8px;
            text-align: left;
            border-bottom: 1px solid rgba(255,255,255,0.2);
        }

        th {
            background: rgba(0,0,0,0.6);
            color: #fff;
            font-weight: bold;
        }

        tr:hover {
            background: rgba(255,255,255,0.05);
        }

        .status-badge {
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            display: inline-block;
        }

        .status-paid { background-color: rgba(0,255,153,0.2); color: #00ff99; }
        .status-pending { background-color: rgba(255,204,0,0.2); color: #ffcc00; }
        .status-cancelled { background-color: rgba(255,77,77,0.2); color: #ff4d4d; }
        .status-completed { background-color: rgba(0,191,255,0.2); color: #00bfff; }

        .btn {
            background-color: rgba(255,255,255,0.1);
            color: #fff;
            padding: 10px 20px;
            border: 1px solid rgba(255,255,255,0.3);
            border-radius: 10px;
            cursor: pointer;
            font-size: 14px;
            margin: 5px;
            transition: 0.3s;
            backdrop-filter: blur(5px);
        }

        .btn:hover {
            background-color: rgba(255,255,255,0.2);
            color: #fff;
        }

        .btn-danger { background-color: rgba(255,77,77,0.2); color: #ff4d4d; }
        .btn-success { background-color: rgba(0,255,153,0.2); color: #00ff99; }

        .filters {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            align-items: center;
            margin-bottom: 20px;
        }

        .filters label {
            color: #fff;
            font-size: 14px;
            font-weight: 600;
        }

        .filters input[type="date"], .filters select {
            padding: 8px 12px;
            border: 1px solid rgba(255,255,255,0.3);
            border-radius: 10px;
            font-size: 14px;
            background: rgba(255,255,255,0.05);
            color: #fff !important;
            backdrop-filter: blur(5px);
        }

        .filters input[type="date"]::-webkit-calendar-picker-indicator {
            filter: invert(1);
            cursor: pointer;
        }

        .empty-state {
            text-align: center;
            padding: 40px;
            color: rgba(255,255,255,0.6);
            font-style: italic;
        }

        @media (max-width: 768px) {
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
            .filters {
                flex-direction: column;
            }
            table {
                font-size: 11px;
            }
        }
    </style>
</head>
<body>
    <div class="navbar">
        <a href="intelli.html">
            <img src="logo.png" alt="IntelliPark Logo">
            <span style="font-size: 20px; font-weight: bold;">INTELLIPARK - ADMIN DASHBOARD</span>
        </a>
        <div style="display: flex; gap: 10px;">
            <button class="btn" onclick="refreshData()">üîÑ Refresh</button>
            <button class="btn btn-success" onclick="resetAllSlots()">üîÑ Reset All Slots</button>
            <button class="btn btn-danger" onclick="logout()">üö™ Logout</button>
        </div>
    </div>

    <div class="container">
        <h1>üìä Dashboard Overview</h1>

        <div class="dashboard-grid">
            <div class="stat-card">
                <div class="stat-label">Total Reservations Today</div>
                <div class="stat-number" id="totalReservations">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Revenue Today</div>
                <div class="stat-number" id="totalRevenue">‚Ç±0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Available Slots</div>
                <div class="stat-number" id="availableSlots">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Occupied Slots</div>
                <div class="stat-number" id="occupiedSlots">0</div>
            </div>
        </div>

        <div class="section">
            <h2 class="section-title">üöó Real-time Slot Status</h2>
            <div class="slots-grid" id="slotsGrid"></div>
        </div>

        <div class="section">
            <h2 class="section-title">üöó Parking Log & Reservations</h2>
            
            <div class="filters">
                <label>From:</label>
                <input type="date" id="filterDateFrom" onchange="filterLogs()">
                
                <label>To:</label>
                <input type="date" id="filterDateTo" onchange="filterLogs()">
                
                <select id="filterStatus" onchange="filterLogs()">
                    <option value="">All Status</option>
                    <option value="Paid">Paid</option>
                    <option value="Pending">Pending</option>
                    <option value="Completed">Completed</option>
                    <option value="Cancelled">Cancelled</option>
                </select>
                
                <button class="btn" onclick="clearFilters()">üîÑ Clear Filters</button>
                <button class="btn btn-success" onclick="fixPendingStatuses()">üîß Fix Pending Status</button>
                <button class="btn btn-success" onclick="exportToPDF()">üì• Export to PDF</button>
                <button class="btn btn-danger" onclick="clearAllReservations()">üóëÔ∏è Clear All Reservations</button>
            </div>

            <div id="logsContainer">
                <table id="logsTable">
                    <thead>
                        <tr>
                            <th>Time In</th>
                            <th>Time Out</th>
                            <th>Duration</th>
                            <th>Slot</th>
                            <th>Name</th>
                            <th>Plate</th>
                            <th>Vehicle</th>
                            <th>Source</th> <!-- New column -->
                            <th>Status</th>
                            <th>Amount</th>
                        </tr>
                    </thead>

                    <tbody id="logsTableBody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyAuH0ng67kSk0arMNOxujgIpnBVr0pwNWE",
            authDomain: "intellipark2025-327e9.firebaseapp.com",
            databaseURL: "https://intellipark2025-327e9-default-rtdb.firebaseio.com",
            projectId: "intellipark2025-327e9",
            storageBucket: "intellipark2025-327e9.appspot.com",
            messagingSenderId: "126333727252",
            appId: "1:126333727252:web:ffa87b61f5e7b3a2122d01"
        };

        (function() {
            const isLoggedIn = sessionStorage.getItem('intellipark_admin_logged_in');
            const loginTime = sessionStorage.getItem('intellipark_admin_login_time');
            if (isLoggedIn !== 'true') {
                window.location.href = 'admin-login.html';
                return;
            }
            if (loginTime) {
                const loginDate = new Date(loginTime);
                const now = new Date();
                const hoursPassed = (now - loginDate) / (1000 * 60 * 60);
                if (hoursPassed > 8) {
                    sessionStorage.removeItem('intellipark_admin_logged_in');
                    sessionStorage.removeItem('intellipark_admin_login_time');
                    window.location.href = 'admin-login.html';
                    return;
                }
            }
        })();

        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        let allReservations = [];
        let slotStatuses = {};

        function initDashboard() {
            console.log('üöÄ Initializing dashboard...');
            loadSlotStatuses();
            loadReservations();

            ['slot1','slot2','slot3','slot4'].forEach(slotId => {
                db.ref(`/${slotId}/status`).on('value', snapshot => {
                    slotStatuses[slotId] = snapshot.val();
                    updateSlotDisplay();
                    updateStatistics();
                });
            });

            // ‚úÖ FIXED: Listen to value changes (includes exitTime updates)
            db.ref('/reservations').on('value', snapshot => {
                console.log('üìä Reservations data updated');
                loadReservations();
            });
            
            db.ref('/walk-in-bookings').on('value', snapshot => {
                console.log('üìä Walk-in bookings updated');
                loadReservations();
            });
        }

        function loadSlotStatuses() {
            ['slot1','slot2','slot3','slot4'].forEach(slotId => {
                db.ref(`/${slotId}/status`).once('value').then(snapshot => {
                    slotStatuses[slotId] = snapshot.val() || 'Available';
                    updateSlotDisplay();
                });
            });
        }

        function updateSlotDisplay() {
            const slotsGrid = document.getElementById('slotsGrid');
            slotsGrid.innerHTML = '';

            const slotNames = {
                slot1: '1st Floor - Slot 1',
                slot2: '1st Floor - Slot 2',
                slot3: '2nd Floor - Slot 3',
                slot4: '2nd Floor - Slot 4'
            };

            Object.keys(slotStatuses).forEach(slotId => {
                const status = slotStatuses[slotId] || 'Available';
                const slotCard = document.createElement('div');
                
                let statusClass = 'slot-available';
                if (status === 'Reserved') statusClass = 'slot-reserved';
                if (status === 'Occupied') statusClass = 'slot-occupied';
                
                slotCard.className = `slot-card ${statusClass}`;
                slotCard.innerHTML = `
                    <h3>${slotNames[slotId]}</h3>
                    <p style="font-size: 18px; margin: 10px 0;">${status.toUpperCase()}</p>
                    ${status !== 'Available' ? `<div class="slot-details">Reserved via system</div>` : ''}
                `;
                slotsGrid.appendChild(slotCard);
            });
        }

        function loadReservations() {
            const reservationsPromise = db.ref('/reservations').once('value');
            const walkinsPromise = db.ref('/walk-in-bookings').once('value');
            
            Promise.all([reservationsPromise, walkinsPromise]).then(([reservationsSnapshot, walkinsSnapshot]) => {
                allReservations = [];
                
                const reservationsData = reservationsSnapshot.val();
                if (reservationsData) {
                    Object.keys(reservationsData).forEach(slotId => {
                        const res = reservationsData[slotId];
                        allReservations.push({
                            slot: slotId,
                            ...res,
                            // ‚úÖ Ensure exitTime is included
                            exitTime: res.exitTime || null
                        });
                    });
                }
                
                const walkinsData = walkinsSnapshot.val();
                if (walkinsData) {
                    Object.keys(walkinsData).forEach(bookingId => {
                        const booking = walkinsData[bookingId];
                        allReservations.push({
                            slot: booking.slot,
                            ...booking,
                            exitTime: booking.exitTime || null
                        });
                    });
                }
                
                console.log('üìã Loaded reservations:', allReservations.length);
                allReservations.sort((a,b)=> new Date(b.timestamp)-new Date(a.timestamp));
                displayLogs(allReservations);
                updateStatistics();
            });
        }

        // ‚úÖ FIXED: Display Time Out and Duration correctly
        function displayLogs(logs) {
            const tbody = document.getElementById('logsTableBody');
            tbody.innerHTML = '';
            
            if(logs.length === 0){
                tbody.innerHTML='<tr><td colspan="9" class="empty-state">No reservations found</td></tr>';
                return;
            }
            
            logs.forEach(log=>{
                const row = document.createElement('tr');
                
                // Time In
                const timeIn = log.timestamp ? new Date(log.timestamp).toLocaleString() : 'N/A';
                
                // ‚úÖ Time Out - check if exitTime exists
                const timeOut = log.exitTime ? new Date(log.exitTime).toLocaleString() : '-';
                
                // ‚úÖ Duration - calculate if both timestamps exist
                let duration = '-';
                if (log.timestamp && log.exitTime) {
                    const entryTime = new Date(log.timestamp);
                    const exitTime = new Date(log.exitTime);
                    const diffMs = exitTime - entryTime;
                    const diffMins = Math.floor(diffMs / 60000);
                    const hours = Math.floor(diffMins / 60);
                    const mins = diffMins % 60;
                    duration = `${hours}h ${mins}m`;
                }
                
                const status = log.status || 'Pending';
                const amount = log.amount || 50;
                
                // In your displayLogs() function, modify the row.innerHTML to include:
                row.innerHTML=`
                    <td>${timeIn}</td>
                    <td>${timeOut}</td>
                    <td><strong>${duration}</strong></td>
                    <td><strong>${log.slot.toUpperCase()}</strong></td>
                    <td>${log.name || 'Walk-In'}</td>
                    <td>${log.plate || 'N/A'}</td>
                    <td>${log.vehicle || 'N/A'}</td>
                    <td><span class="status-badge">${log.reservedVia || 'Kiosk'}</span></td>
                    <td><span class="status-badge status-${status.toLowerCase()}">${status}</span></td>
                    <td>‚Ç±${amount}</td>
                `;

                tbody.appendChild(row);
            });
            
            console.log('‚úÖ Displayed', logs.length, 'logs');
        }

        function updateStatistics() {
            const today = new Date().toDateString();
            const todayReservations = allReservations.filter(r=>new Date(r.timestamp).toDateString()===today);
            const revenue = todayReservations.reduce((sum,r)=>sum+(r.amount||50),0);
            const available = Object.values(slotStatuses).filter(s=>s==='Available').length;
            const occupied = Object.values(slotStatuses).filter(s=>s==='Occupied'||s==='Reserved').length;

            document.getElementById('totalReservations').textContent = todayReservations.length;
            document.getElementById('totalRevenue').textContent = '‚Ç±'+revenue;
            document.getElementById('availableSlots').textContent = available;
            document.getElementById('occupiedSlots').textContent = occupied;
        }

        function filterLogs() {
            const dateFrom = document.getElementById('filterDateFrom').value;
            const dateTo = document.getElementById('filterDateTo').value;
            const statusFilter = document.getElementById('filterStatus').value;
            
            let filtered = allReservations;
            
            if (dateFrom && dateTo) {
                const fromDate = new Date(dateFrom);
                const toDate = new Date(dateTo);
                toDate.setHours(23, 59, 59, 999);
                
                filtered = filtered.filter(r => {
                    const reservationDate = new Date(r.timestamp);
                    return reservationDate >= fromDate && reservationDate <= toDate;
                });
            } else if (dateFrom) {
                const fromDate = new Date(dateFrom);
                filtered = filtered.filter(r => new Date(r.timestamp) >= fromDate);
            } else if (dateTo) {
                const toDate = new Date(dateTo);
                toDate.setHours(23, 59, 59, 999);
                filtered = filtered.filter(r => new Date(r.timestamp) <= toDate);
            }
            
            if (statusFilter) {
                filtered = filtered.filter(r => (r.status || 'Pending') === statusFilter);
            }
            
            displayLogs(filtered);
            updateFilterSummary(filtered.length, dateFrom, dateTo, statusFilter);
        }

        function clearFilters() {
            document.getElementById('filterDateFrom').value = '';
            document.getElementById('filterDateTo').value = '';
            document.getElementById('filterStatus').value = '';
            displayLogs(allReservations);
            updateFilterSummary(allReservations.length, '', '', '');
        }

        function updateFilterSummary(count, dateFrom, dateTo, status) {
            let summaryText = `Showing ${count} reservation(s)`;
            
            if (dateFrom && dateTo) {
                summaryText += ` from ${dateFrom} to ${dateTo}`;
            } else if (dateFrom) {
                summaryText += ` from ${dateFrom} onwards`;
            } else if (dateTo) {
                summaryText += ` up to ${dateTo}`;
            }
            
            if (status) {
                summaryText += ` with status: ${status}`;
            }
            
            let summaryEl = document.getElementById('filterSummary');
            if (!summaryEl) {
                summaryEl = document.createElement('div');
                summaryEl.id = 'filterSummary';
                summaryEl.style.cssText = 'color: rgba(255,255,255,0.7); font-size: 14px; margin: 10px 0; font-style: italic;';
                document.getElementById('logsContainer').insertBefore(summaryEl, document.getElementById('logsTable'));
            }
            
            summaryEl.textContent = summaryText;
        }

        async function fixPendingStatuses() {
            if (!confirm('Fix all "Pending" entries to "Paid"?')) return;
            
            try {
                const snapshot = await db.ref('/reservations').once('value');
                const reservations = snapshot.val();
                
                if (!reservations) {
                    alert('No reservations found');
                    return;
                }
                
                let updateCount = 0;
                
                for (const [slot, reservation] of Object.entries(reservations)) {
                    if (reservation.status === 'Pending' || !reservation.status) {
                        await db.ref(`/reservations/${slot}`).update({ status: 'Paid' });
                        updateCount++;
                    }
                }
                
                alert(`‚úÖ Updated ${updateCount} reservation(s) to "Paid" status`);
                refreshData();
                
            } catch (error) {
                console.error('Error fixing statuses:', error);
                alert('Failed to update statuses');
            }
        }

        function exportToPDF() {
            if(allReservations.length === 0) { 
                alert('No data to export'); 
                return; 
            }

            try {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF('landscape');

                const dateFrom = document.getElementById('filterDateFrom').value;
                const dateTo = document.getElementById('filterDateTo').value;
                const statusFilter = document.getElementById('filterStatus').value;

                let dataToExport = allReservations;
                
                if (dateFrom && dateTo) {
                    const fromDate = new Date(dateFrom);
                    const toDate = new Date(dateTo);
                    toDate.setHours(23, 59, 59, 999);
                    dataToExport = dataToExport.filter(r => {
                        const reservationDate = new Date(r.timestamp);
                        return reservationDate >= fromDate && reservationDate <= toDate;
                    });
                } else if (dateFrom) {
                    const fromDate = new Date(dateFrom);
                    dataToExport = dataToExport.filter(r => new Date(r.timestamp) >= fromDate);
                } else if (dateTo) {
                    const toDate = new Date(dateTo);
                    toDate.setHours(23, 59, 59, 999);
                    dataToExport = dataToExport.filter(r => new Date(r.timestamp) <= toDate);
                }
                
                if (statusFilter) {
                    dataToExport = dataToExport.filter(r => (r.status || 'Pending') === statusFilter);
                }

                doc.setFontSize(18);
                doc.setTextColor(0, 0, 0);
                doc.text('IntelliPark - Parking Log Report', 14, 20);

                doc.setFontSize(11);
                doc.setTextColor(100);
                doc.text(`Generated: ${new Date().toLocaleString()}`, 14, 28);
                
                let yPos = 34;
                if (dateFrom && dateTo) {
                    doc.text(`Period: ${dateFrom} to ${dateTo}`, 14, yPos);
                    yPos += 6;
                } else if (dateFrom) {
                    doc.text(`Period: From ${dateFrom}`, 14, yPos);
                    yPos += 6;
                } else if (dateTo) {
                    doc.text(`Period: Up to ${dateTo}`, 14, yPos);
                    yPos += 6;
                }
                
                if (statusFilter) {
                    doc.text(`Status Filter: ${statusFilter}`, 14, yPos);
                    yPos += 6;
                }
                
                doc.text(`Total Reservations: ${dataToExport.length}`, 14, yPos);
                yPos += 6;

                const totalRevenue = dataToExport.reduce((sum, r) => sum + (r.amount || 50), 0);
                doc.text(`Total Revenue: ‚Ç±${totalRevenue}`, 14, yPos);

                const tableData = dataToExport.map(r => {
                    const timeIn = r.timestamp ? new Date(r.timestamp).toLocaleString() : 'N/A';
                    const timeOut = r.exitTime ? new Date(r.exitTime).toLocaleString() : '-';
                    
                    let duration = '-';
                    if (r.timestamp && r.exitTime) {
                        const entryTime = new Date(r.timestamp);
                        const exitTime = new Date(r.exitTime);
                        const diffMs = exitTime - entryTime;
                        const diffMins = Math.floor(diffMs / 60000);
                        const hours = Math.floor(diffMins / 60);
                        const mins = diffMins % 60;
                        duration = `${hours}h ${mins}m`;
                    }
                    
                    return [
                        timeIn,
                        timeOut,
                        duration,
                        r.slot.toUpperCase(),
                        r.name || 'Walk-In',
                        r.plate || 'N/A',
                        r.vehicle || 'N/A',
                        r.status || 'Pending',
                        `‚Ç±${r.amount || 50}`
                    ];
                });

                doc.autoTable({
                    head: [['Time In', 'Time Out', 'Duration', 'Slot', 'Name', 'Plate', 'Vehicle', 'Status', 'Amount']],
                    body: tableData,
                    startY: yPos + 8,
                    theme: 'grid',
                    styles: { fontSize: 7, cellPadding: 2 },
                    headStyles: {
                        fillColor: [0, 0, 0],
                        textColor: [255, 255, 255],
                        fontStyle: 'bold',
                        fontSize: 8
                    },
                    alternateRowStyles: { fillColor: [245, 245, 245] },
                    columnStyles: {
                        0: { cellWidth: 35 },
                        1: { cellWidth: 35 },
                        2: { cellWidth: 20 },
                        3: { cellWidth: 15 },
                        4: { cellWidth: 30 },
                        5: { cellWidth: 20 },
                        6: { cellWidth: 20 },
                        7: { cellWidth: 18 },
                        8: { cellWidth: 18 }
                    }
                });

                const pageCount = doc.internal.getNumberOfPages();
                for (let i = 1; i <= pageCount; i++) {
                    doc.setPage(i);
                    doc.setFontSize(9);
                    doc.setTextColor(150);
                    doc.text(
                        `Page ${i} of ${pageCount}`,
                        doc.internal.pageSize.getWidth() / 2,
                        doc.internal.pageSize.getHeight() - 10,
                        { align: 'center' }
                    );
                }

                let filename = 'IntelliPark_ParkingLog';
                if (dateFrom && dateTo) {
                    filename += `_${dateFrom}_to_${dateTo}`;
                } else {
                    filename += `_${new Date().toISOString().split('T')[0]}`;
                }
                filename += '.pdf';
                
                doc.save(filename);
                console.log('‚úÖ PDF exported successfully');
            } catch (error) {
                console.error('‚ùå Error generating PDF:', error);
                alert('Failed to generate PDF. Please try again.');
            }
        }

        function clearAllReservations(){
            if(confirm('Are you sure you want to delete all reservations?')){
                db.ref('/reservations').remove();
                allReservations=[];
                displayLogs([]);
                updateStatistics();
            }
        }

        async function resetAllSlots() {
            if (!confirm('‚ö†Ô∏è Are you sure you want to reset ALL slots to Available?\n\nThis will:\n‚Ä¢ Set all slots to Available status\n‚Ä¢ Keep all reservation logs for records\n\nSlots will be ready for new bookings.')) {
                return;
            }

            try {
                await db.ref("/").update({
                    slot1: { status: "Available", reserved: false },
                    slot2: { status: "Available", reserved: false },
                    slot3: { status: "Available", reserved: false },
                    slot4: { status: "Available", reserved: false }
                });

                alert('‚úÖ All slots have been reset to Available!\n\nüìù Reservation logs are preserved for records.');
                refreshData();

            } catch (error) {
                console.error('‚ùå Error resetting slots:', error);
                alert('‚ùå Failed to reset slots. Please try again.');
            }
        }

        function refreshData(){
            console.log('üîÑ Refreshing data...');
            loadSlotStatuses();
            loadReservations();
        }

        function logout(){
            sessionStorage.removeItem('intellipark_admin_logged_in');
            sessionStorage.removeItem('intellipark_admin_login_time');
            window.location.href='admin-login.html';
        }

        window.onload = initDashboard;
    </script>
</body>
</html>
