<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - INTELLIPARK</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', sans-serif;
        }

        body {
            background: linear-gradient(135deg, #000000, #1b1a1a);
            min-height: 100vh;
            color: #fff;
        }

        /* Glass navbar */
        .navbar {
            background: rgba(0,0,0,0.5);
            backdrop-filter: blur(10px);
            color: white;
            padding: 15px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 1000;
            border-radius: 0 0 15px 15px;
            box-shadow: 0 4px 30px rgba(0,0,0,0.5);
        }

        .navbar a {
            color: white;
            text-decoration: none;
            display: flex;
            align-items: center;
        }

        .navbar img {
            height: 40px;
            margin-right: 10px;
        }

        .container {
            max-width: 1400px;
            margin: 20px auto;
            padding: 0 20px;
        }

        h1 {
            color: #fff;
            margin-bottom: 20px;
            font-size: 32px;
            text-shadow: 0 2px 5px rgba(0,0,0,0.5);
        }

        /* Glass stat cards */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.2);
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.2);
            text-align: center;
            transition: transform 0.3s, background 0.3s;
            backdrop-filter: blur(8px);
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 40px rgba(0,0,0,0.3);
            background: rgba(255,255,255,0.1);
        }

        .stat-number {
            font-size: 36px;
            font-weight: bold;
            color: #fff;
            margin: 10px 0;
            text-shadow: 0 2px 5px rgba(0,0,0,0.5);
        }

        .stat-label {
            color: rgba(255,255,255,0.7);
            font-size: 14px;
            text-transform: uppercase;
        }

        .section {
            background: rgba(0,0,0,0.4);
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
            margin-bottom: 20px;
            backdrop-filter: blur(8px);
            border: 1px solid rgba(255,255,255,0.1);
        }

        .section-title {
            font-size: 22px;
            color: #fff;
            margin-bottom: 15px;
            border-bottom: 1px solid rgba(255,255,255,0.2);
            padding-bottom: 10px;
        }

        .slots-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .slot-card {
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            font-weight: bold;
            color: #fff;
            position: relative;
            background: rgba(255,255,255,0.05);
            backdrop-filter: blur(8px);
            border: 1px solid rgba(255,255,255,0.15);
            transition: 0.3s;
        }

        .slot-card:hover {
            transform: translateY(-3px);
            background: rgba(255,255,255,0.08);
        }

        .slot-available {
            background: rgba(0,255,153,0.2);
            color: #00ff99;
        }

        .slot-reserved {
            background: rgba(0,191,255,0.2);
            color: #00bfff;
        }

        .slot-occupied {
            background: rgba(255,77,77,0.2);
            color: #ff4d4d;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            color: #fff;
        }

        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid rgba(255,255,255,0.2);
        }

        th {
            background: rgba(0,0,0,0.6);
            color: #fff;
            font-weight: bold;
        }

        tr:hover {
            background: rgba(255,255,255,0.05);
        }

        .status-badge {
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            display: inline-block;
        }

        .status-paid { background-color: rgba(0,255,153,0.2); color: #00ff99; }
        .status-pending { background-color: rgba(255,204,0,0.2); color: #ffcc00; }
        .status-cancelled { background-color: rgba(255,77,77,0.2); color: #ff4d4d; }

        .btn {
            background-color: rgba(255,255,255,0.1);
            color: #fff;
            padding: 10px 20px;
            border: 1px solid rgba(255,255,255,0.3);
            border-radius: 10px;
            cursor: pointer;
            font-size: 14px;
            margin: 5px;
            transition: 0.3s;
            backdrop-filter: blur(5px);
        }

        .btn:hover {
            background-color: rgba(255,255,255,0.2);
            color: #fff;
        }

        .btn-danger { background-color: rgba(255,77,77,0.2); color: #ff4d4d; }
        .btn-success { background-color: rgba(0,255,153,0.2); color: #00ff99; }

        .filters input, .filters select {
            padding: 8px 12px;
            border: 1px solid rgba(255,255,255,0.3);
            border-radius: 10px;
            font-size: 14px;
            background: rgba(255,255,255,0.05);
            color: #000000;
            backdrop-filter: blur(5px);
        }

        .empty-state {
            text-align: center;
            padding: 40px;
            color: rgba(255,255,255,0.6);
            font-style: italic;
        }

        @media (max-width: 768px) {
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
            .filters {
                flex-direction: column;
            }
            table {
                font-size: 12px;
            }
        }
    </style>
</head>
<body>
    <div class="navbar">
        <a href="intelli.html">
            <img src="logo.png" alt="IntelliPark Logo">
            <span style="font-size: 20px; font-weight: bold;">INTELLIPARK - ADMIN DASHBOARD</span>
        </a>
        <div style="display: flex; gap: 10px;">
            <button class="btn" onclick="refreshData()">üîÑ Refresh</button>
            <button class="btn btn-success" onclick="resetAllSlots()">üîÑ Reset All Slots</button>
            <button class="btn btn-danger" onclick="logout()">üö™ Logout</button>
        </div>
    </div>

    <div class="container">
        <h1>üìä Dashboard Overview</h1>

        <!-- Statistics Cards -->
        <div class="dashboard-grid">
            <div class="stat-card">
                <div class="stat-label">Total Reservations Today</div>
                <div class="stat-number" id="totalReservations">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Revenue Today</div>
                <div class="stat-number" id="totalRevenue">‚Ç±0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Available Slots</div>
                <div class="stat-number" id="availableSlots">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Occupied Slots</div>
                <div class="stat-number" id="occupiedSlots">0</div>
            </div>
        </div>

        <!-- Real-time Slot Status -->
        <div class="section">
            <h2 class="section-title">üöó Real-time Slot Status</h2>
            <div class="slots-grid" id="slotsGrid">
                <!-- Slots will be populated here -->
            </div>
        </div>

        <!-- Activity Logs -->
        <div class="section">
            <h2 class="section-title">üìã Activity Logs & Reservations</h2>
            
            <div class="filters">
                <input type="date" id="filterDate" onchange="filterLogs()">
                <select id="filterStatus" onchange="filterLogs()">
                    <option value="">All Status</option>
                    <option value="Paid">Paid</option>
                    <option value="Pending">Pending</option>
                    <option value="Cancelled">Cancelled</option>
                </select>
                <button class="btn btn-success" onclick="exportToCSV()">üì• Export to CSV</button>
                <button class="btn btn-danger" onclick="clearAllReservations()">üóëÔ∏è Clear All Reservations</button>
            </div>

            <div id="logsContainer">
                <table id="logsTable">
                    <thead>
                        <tr>
                            <th>Time</th>
                            <th>Slot</th>
                            <th>Name</th>
                            <th>Email</th>
                            <th>Plate</th>
                            <th>Vehicle</th>
                            <th>Status</th>
                            <th>Amount</th>
                            <th>Invoice ID</th>
                        </tr>
                    </thead>
                    <tbody id="logsTableBody">
                        <!-- Logs will be populated here -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyAuH0ng67kSk0arMNOxujgIpnBVr0pwNWE",
            authDomain: "intellipark2025-327e9.firebaseapp.com",
            databaseURL: "https://intellipark2025-327e9-default-rtdb.firebaseio.com",
            projectId: "intellipark2025-327e9",
            storageBucket: "intellipark2025-327e9.appspot.com",
            messagingSenderId: "126333727252",
            appId: "1:126333727252:web:ffa87b61f5e7b3a2122d01"
        };

        // ‚úÖ Authentication check
        (function() {
            const isLoggedIn = sessionStorage.getItem('intellipark_admin_logged_in');
            const loginTime = sessionStorage.getItem('intellipark_admin_login_time');
            if (isLoggedIn !== 'true') {
                window.location.href = 'admin-login.html';
                return;
            }
            if (loginTime) {
                const loginDate = new Date(loginTime);
                const now = new Date();
                const hoursPassed = (now - loginDate) / (1000 * 60 * 60);
                if (hoursPassed > 8) {
                    sessionStorage.removeItem('intellipark_admin_logged_in');
                    sessionStorage.removeItem('intellipark_admin_login_time');
                    window.location.href = 'admin-login.html';
                    return;
                }
            }
        })();

        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        let allReservations = [];
        let slotStatuses = {};

        function initDashboard() {
            loadSlotStatuses();
            loadReservations();

            ['slot1','slot2','slot3','slot4'].forEach(slotId => {
                db.ref(`/${slotId}/status`).on('value', snapshot => {
                    slotStatuses[slotId] = snapshot.val();
                    updateSlotDisplay();
                    updateStatistics();
                });
            });

            db.ref('/reservations').on('value', snapshot => {
                loadReservations();
            });
        }

        function loadSlotStatuses() {
            ['slot1','slot2','slot3','slot4'].forEach(slotId => {
                db.ref(`/${slotId}/status`).once('value').then(snapshot => {
                    slotStatuses[slotId] = snapshot.val() || 'Available';
                    updateSlotDisplay();
                });
            });
        }

        function updateSlotDisplay() {
            const slotsGrid = document.getElementById('slotsGrid');
            slotsGrid.innerHTML = '';

            const slotNames = {
                slot1: '1st Floor - Slot 1',
                slot2: '1st Floor - Slot 2',
                slot3: '2nd Floor - Slot 3',
                slot4: '2nd Floor - Slot 4'
            };

            Object.keys(slotStatuses).forEach(slotId => {
                const status = slotStatuses[slotId] || 'Available';
                const slotCard = document.createElement('div');
                
                let statusClass = 'slot-available';
                if (status === 'Reserved') statusClass = 'slot-reserved';
                if (status === 'Occupied') statusClass = 'slot-occupied';
                
                slotCard.className = `slot-card ${statusClass}`;
                slotCard.innerHTML = `
                    <h3>${slotNames[slotId]}</h3>
                    <p style="font-size: 18px; margin: 10px 0;">${status.toUpperCase()}</p>
                    ${status !== 'Available' ? `<div class="slot-details">Reserved via system</div>` : ''}
                `;
                slotsGrid.appendChild(slotCard);
            });
        }

        function loadReservations() {
            db.ref('/reservations').once('value').then(snapshot => {
                allReservations = [];
                const data = snapshot.val();
                if (data) {
                    Object.keys(data).forEach(slotId => {
                        allReservations.push({slot: slotId, ...data[slotId]});
                    });
                }
                allReservations.sort((a,b)=> new Date(b.timestamp)-new Date(a.timestamp));
                displayLogs(allReservations);
                updateStatistics();
            });
        }

        function displayLogs(logs) {
            const tbody = document.getElementById('logsTableBody');
            tbody.innerHTML = '';
            if(logs.length===0){
                tbody.innerHTML='<tr><td colspan="9" class="empty-state">No reservations found</td></tr>';
                return;
            }
            logs.forEach(log=>{
                const row=document.createElement('tr');
                const time=new Date(log.timestamp).toLocaleString();
                const status=log.status||'Pending';
                const amount=log.amount||50;
                row.innerHTML=`
                    <td>${time}</td>
                    <td><strong>${log.slot.toUpperCase()}</strong></td>
                    <td>${log.name||'N/A'}</td>
                    <td>${log.email||'N/A'}</td>
                    <td>${log.plate||'N/A'}</td>
                    <td>${log.vehicle||'N/A'}</td>
                    <td><span class="status-badge status-${status.toLowerCase()}">${status}</span></td>
                    <td>‚Ç±${amount}</td>
                    <td style="font-size: 11px;">${log.invoiceId||'N/A'}</td>
                `;
                tbody.appendChild(row);
            });
        }

        function updateStatistics() {
            const today = new Date().toDateString();
            const todayReservations = allReservations.filter(r=>new Date(r.timestamp).toDateString()===today);
            const revenue = todayReservations.reduce((sum,r)=>sum+(r.amount||50),0);
            const available = Object.values(slotStatuses).filter(s=>s==='Available').length;
            const occupied = Object.values(slotStatuses).filter(s=>s==='Occupied'||s==='Reserved').length;

            document.getElementById('totalReservations').textContent = todayReservations.length;
            document.getElementById('totalRevenue').textContent = '‚Ç±'+revenue;
            document.getElementById('availableSlots').textContent = available;
            document.getElementById('occupiedSlots').textContent = occupied;
        }

        function filterLogs() {
            const dateFilter=document.getElementById('filterDate').value;
            const statusFilter=document.getElementById('filterStatus').value;
            let filtered = allReservations;
            if(dateFilter){
                filtered = filtered.filter(r=>new Date(r.timestamp).toDateString()===new Date(dateFilter).toDateString());
            }
            if(statusFilter){
                filtered = filtered.filter(r=>(r.status||'Pending')===statusFilter);
            }
            displayLogs(filtered);
        }

        function exportToCSV() {
            if(allReservations.length===0){ alert('No data to export'); return; }
            let csv='Timestamp,Slot,Name,Email,Plate,Vehicle,Status,Amount,Invoice ID\n';
            allReservations.forEach(r=>{
                csv+=`"${new Date(r.timestamp).toLocaleString()}","${r.slot}","${r.name||'N/A'}","${r.email||'N/A'}","${r.plate||'N/A'}","${r.vehicle||'N/A'}","${r.status||'Pending'}","${r.amount||50}","${r.invoiceId||'N/A'}"\n`;
            });
            const blob=new Blob([csv],{type:'text/csv'});
            const url=URL.createObjectURL(blob);
            const a=document.createElement('a'); a.href=url; a.download='intellipark_reservations.csv'; a.click();
            URL.revokeObjectURL(url);
        }

        function clearAllReservations(){
            if(confirm('Are you sure you want to delete all reservations?')){
                db.ref('/reservations').remove();
                allReservations=[];
                displayLogs([]);
                updateStatistics();
            }
        }

        // ‚úÖ NEW: Reset All Slots Function
        async function resetAllSlots() {
            if (!confirm('‚ö†Ô∏è Are you sure you want to reset ALL slots to Available?\n\nThis will:\n‚Ä¢ Clear all reservations\n‚Ä¢ Set all slots to Available\n‚Ä¢ Remove all slot data\n‚Ä¢ Clear walk-in bookings\n\nThis action cannot be undone!')) {
                return;
            }

            try {
                // Reset all slot statuses
                await db.ref("/").update({
                    slot1: { status: "Available", reserved: false },
                    slot2: { status: "Available", reserved: false },
                    slot3: { status: "Available", reserved: false },
                    slot4: { status: "Available", reserved: false }
                });

                // Clear all reservations
                await db.ref('/reservations').remove();

                // Clear walk-in bookings (if they exist)
                await db.ref('/walk-in-bookings').remove();

                alert('‚úÖ All slots have been reset successfully!');
                
                // Refresh the dashboard
                refreshData();

            } catch (error) {
                console.error('‚ùå Error resetting slots:', error);
                alert('‚ùå Failed to reset slots. Please try again.');
            }
        }

        function refreshData(){
            loadSlotStatuses();
            loadReservations();
        }

        function logout(){
            sessionStorage.removeItem('intellipark_admin_logged_in');
            sessionStorage.removeItem('intellipark_admin_login_time');
            window.location.href='admin-login.html';
        }

        window.onload = initDashboard;
    </script>
</body>
</html>
