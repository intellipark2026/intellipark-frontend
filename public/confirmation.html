<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Reservation Confirmation - INTELLIPARK</title>
  <link rel="stylesheet" href="style.css">
  <script src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js"></script>
  <script>
    (function(){
      emailjs.init("Jt7LWhzpR4vECWuKG"); // 🔑 Replace with your EmailJS public key
    })();
  </script>
</head>
<body>
  <div class="container">
    <h2>🎉 Reservation Confirmed!</h2>
    <p>Your payment was successful. Your reservation has been saved.</p>
    <button id="viewReceipt">View Receipt</button>
  </div>

  <script>
    const params = new URLSearchParams(window.location.search);
    const slot = params.get("slot");
    const name = params.get("name");
    const plate = params.get("plate");
    const vehicle = params.get("vehicle");
    const email = params.get("email");
    const time = params.get("time");

    async function confirmReservation() {
      try {
        const response = await fetch("https://intellipark-backend-ar00.onrender.com/api/confirm-payment", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ slot, name, plate, vehicle, email, time })
        });

        const result = await response.json();
        console.log("Reservation confirmed:", result);

        if (result.success) {
          // Send confirmation email with EmailJS
          emailjs.send("service_ubjbmis", "template_x2h90up", {
            to_email: email,
            name: name,
            plate: plate,
            vehicle: vehicle,
            slot: slot,
            time: time,
            qr_code: result.qr // QR image from backend
          })
          .then(() => {
            console.log("✅ Email sent successfully");
          })
          .catch((err) => {
            console.error("❌ Error sending email:", err);
          });
        }
      } catch (err) {
        console.error("Error confirming reservation:", err);
      }
    }

    document.getElementById("viewReceipt").addEventListener("click", () => {
      window.location.href = `receipt.html?slot=${slot}&email=${email}`;
    });

    // Auto confirm on page load
    confirmReservation();
  </script>
</body>
</html>
