<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Book Parking - INTELLIPARK</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <div class="navbar" style="display: flex; align-items: center; padding: 10px 20px; background-color: purple;">
    <a id="homeBtn" href="intelli.html" style="display: flex; align-items: center; text-decoration: none; color: white;">
      <img src="logo.png" alt="IntelliPark Logo" style="height: 40px; margin-right: 10px;">
      <span style="font-size: 20px; font-weight: bold;">INTELLIPARK</span>
    </a>
  </div>


  <div class="container">
    <h2>BOOK YOUR PARKING SPOT</h2>
    <p><strong>Selected Slot:</strong> <span id="selectedSlot" style="color: green; font-weight: bold;"></span></p>
    <form id="bookingForm">
      <div class="form-group">
        <label for="name">NAME:</label>
        <input type="text" id="name" required>
      </div>
      <div class="form-group">
        <label for="email">EMAIL:</label>
        <input type="email" id="email" required>
      </div>
      <div class="form-group">
        <label for="plate">PLATE NUMBER:</label>
        <input type="text" id="plate" required placeholder="e.g., ABC123" pattern="^[A-Za-z]{3}[0-9]{3}$">
      </div>
      <div class="form-group">
        <label for="vehicle">VEHICLE TYPE:</label>
        <select id="vehicle" required>
          <option value="car">Car</option>
          <option value="motorcycle">Motorcycle</option>
        </select>
      </div>
      <div class="form-group">
        <label for="time">PARKING TIME:</label>
        <input type="time" id="time" required>
      </div>
      <button type="submit" class="submit-btn">Reserve Now</button>
    </form>


    <button id="resetButton" style="margin-top: 20px; background-color: red; color: white; padding: 10px 15px; border: none; cursor: pointer;">
      Reset All Reservations (Admin)
    </button>


    <a id="backHomeBtn" href="intelli.html" class="back-btn">← Back to Home</a>
  </div>


  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>


  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyAuH0ng67kSk0arMNOxujgIpnBVr0pwNWE",
      authDomain: "intellipark2025-327e9.firebaseapp.com",
      databaseURL: "https://intellipark2025-327e9-default-rtdb.firebaseio.com",
      projectId: "intellipark2025-327e9",
      storageBucket: "intellipark2025-327e9.appspot.com",
      messagingSenderId: "126333727252",
      appId: "1:126333727252:web:ffa87b61f5e7b3a2122d01"
    };


    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // ✅ GET SLOT FROM URL PARAMETER
    const params = new URLSearchParams(window.location.search);
    const selectedSlot = params.get("slot");

    // Validate that slot exists
    if (!selectedSlot) {
      alert("No slot selected. Redirecting to slot selection...");
      window.location.href = "levels.html";
    }

    // Display selected slot to user
    document.getElementById("selectedSlot").textContent = selectedSlot.toUpperCase();

    const form = document.getElementById("bookingForm");
    const timeInput = document.getElementById("time");


    // Helper: convert "HH:MM" to minutes
    function timeToMinutes(t) {
      const [h, m] = t.split(":").map(Number);
      return h * 60 + m;
    }


    function normalize(date) {
      date.setSeconds(0);
      date.setMilliseconds(0);
      return date;
    }


    // Limit booking time: now → +2 hours
    function setMinMaxTime() {
      const now = new Date();
      const hhMin = String(now.getHours()).padStart(2, "0");
      const mmMin = String(now.getMinutes()).padStart(2, "0");
      timeInput.min = `${hhMin}:${mmMin}`;


      now.setMinutes(now.getMinutes() + 120);
      const hhMax = String(now.getHours()).padStart(2, "0");
      const mmMax = String(now.getMinutes()).padStart(2, "0");
      timeInput.max = `${hhMax}:${mmMax}`;
    }
    document.addEventListener("DOMContentLoaded", setMinMaxTime);


    // Form Submission
    form.addEventListener("submit", async function(e) {
      e.preventDefault();


      const name = document.getElementById("name").value.trim();
      const email = document.getElementById("email").value.trim();
      const plate = document.getElementById("plate").value.trim();
      const vehicle = document.getElementById("vehicle").value;
      const time = document.getElementById("time").value;
      const timestamp = new Date().toISOString();


      // Plate validation
      const platePattern = /^[A-Za-z]{3}[0-9]{3}$/;
      if (!platePattern.test(plate)) {
        return alert("Plate number must be in the format ABC123 (3 letters + 3 digits).");
      }


      // Time validation
      const now = normalize(new Date());
      const selectedTime = normalize(new Date());
      const [hh, mm] = time.split(":").map(Number);
      selectedTime.setHours(hh, mm, 0, 0);


      const maxTime = normalize(new Date());
      maxTime.setMinutes(maxTime.getMinutes() + 120);


      if (selectedTime < now) return alert("You cannot book a time in the past.");
      if (selectedTime > maxTime) return alert("You cannot book more than 2 hours from now.");


      try {
        // ✅ VERIFY THE SELECTED SLOT IS STILL AVAILABLE
        const slotStatus = await db.ref(`/${selectedSlot}/status`).get();
        
        if (!slotStatus.exists() || slotStatus.val() !== "Available") {
          alert(`Sorry, ${selectedSlot} is no longer available. Redirecting to slot selection...`);
          window.location.href = "levels.html";
          return;
        }

        // ✅ USE THE SELECTED SLOT (NOT RE-QUERY)
        const slotId = selectedSlot;

        // Call backend to create invoice
        const res = await fetch("https://intellipark-backend-ar00.onrender.com/api/create-invoice", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ name, email, plate, vehicle, time, slot: slotId })
        });


        const result = await res.json();
        if (result.invoice_url) {
          window.location.href = result.invoice_url;
        } else {
          alert("Failed to create invoice. Please try again.");
        }
      } catch (err) {
        console.error("Reservation error:", err);
        alert("Something went wrong. Please try again.");
      }
    });


    // Reset All Reservations (Admin)
    document.getElementById("resetButton").addEventListener("click", async () => {
      if (!confirm("Are you sure you want to reset ALL reservations?")) return;


      try {
        await db.ref("reservations").remove();
        await Promise.all([
          db.ref("slot1").update({ status: "Available", reserved: false }),
          db.ref("slot2").update({ status: "Available", reserved: false }),
          db.ref("slot3").update({ status: "Available", reserved: false }),
          db.ref("slot4").update({ status: "Available", reserved: false })
        ]);
        alert("All reservations have been cleared successfully.");
      } catch (err) {
        console.error("Failed to reset reservations:", err);
        alert("Error resetting reservations. Check console.");
      }
    });


    // Auto-detect navigation for home/back buttons
    document.addEventListener("DOMContentLoaded", function() {
      const isLocal = (location.hostname === "127.0.0.1" || location.hostname === "localhost");
      const prefix = isLocal ? "http://127.0.0.1:5500/public/" : "";
      const homeBtn = document.getElementById("homeBtn");
      const backHomeBtn = document.getElementById("backHomeBtn");
      if (homeBtn) homeBtn.href = prefix + "intelli.html";
      if (backHomeBtn) backHomeBtn.href = prefix + "intelli.html";
    });
  </script>
</body>
</html>
