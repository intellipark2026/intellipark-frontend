<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Book Parking - IntelliPark</title>

  <!-- PWA Configuration -->
  <link rel="icon" type="image/x-icon" href="/favicon.ico">
  <link rel="apple-touch-icon" href="/apple-touch-icon.png">
  <link rel="manifest" href="/manifest.json">
  <meta name="theme-color" content="#000000">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <meta name="apple-mobile-web-app-title" content="IntelliPark">

  <!-- Service Worker Registration -->
  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('/sw.js')
          .then(reg => console.log('‚úÖ SW registered'))
          .catch(err => console.error('‚ùå SW error:', err));
      });
    }
  </script>

  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: 'Poppins', sans-serif;
      background: #0d0d0d;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      color: #fff;
      overflow-x: hidden;
    }

    /* NAVBAR */
    .navbar {
      width: 100%;
      padding: 14px 28px;
      display: flex;
      align-items: center;
      background: rgba(30, 30, 30, 0.6);
      backdrop-filter: blur(12px);
      box-shadow: 0 4px 20px rgba(255, 255, 255, 0.05);
      border-bottom: 2px solid rgba(255,255,255,0.1);
    }

    .navbar a {
      display: flex;
      align-items: center;
      text-decoration: none;
      color: #fff;
      font-weight: 600;
      font-size: 20px;
      letter-spacing: 1px;
    }

    .navbar img {
      height: 40px;
      margin-right: 10px;
      filter: brightness(1.2);
    }

    /* FORM CONTAINER */
    .container {
      background: rgba(200,200,200,0.1);
      backdrop-filter: blur(20px);
      border-radius: 25px;
      padding: 40px 50px;
      margin-top: 60px;
      margin-bottom: 40px;
      width: 95%;
      max-width: 520px;
      box-shadow: 0 8px 40px rgba(0,0,0,0.3);
      border: 1px solid rgba(255,255,255,0.15);
      text-align: center;
      color: #fff;
    }

    h2 {
      font-size: 26px;
      margin-bottom: 10px;
      letter-spacing: 1px;
      color: #fff;
      text-shadow:
        0 0 5px #fff,
        0 0 10px #fff,
        0 0 20px #fff,
        0 0 30px rgba(255,255,255,0.4),
        0 0 40px rgba(255,255,255,0.3),
        0 0 50px rgba(255,255,255,0.2);
      animation: glowPulse 2s infinite alternate;
    }

    @keyframes glowPulse {
      0% { text-shadow: 0 0 5px #fff,0 0 10px #fff,0 0 20px #fff,0 0 30px rgba(255,255,255,0.4),0 0 40px rgba(255,255,255,0.3),0 0 50px rgba(255,255,255,0.2);}
      100% { text-shadow:0 0 10px #fff,0 0 20px #fff,0 0 30px #fff,0 0 40px rgba(255,255,255,0.5),0 0 50px rgba(255,255,255,0.4),0 0 60px rgba(255,255,255,0.3);}
    }

    p {
      font-size: 16px;
      margin-bottom: 25px;
      color: #ccc;
    }

    /* FORM ELEMENTS */
    .form-group {
      text-align: left;
      margin-bottom: 20px;
    }

    label {
      display: block;
      font-weight: 600;
      margin-bottom: 6px;
      color: #ddd;
      font-size: 15px;
    }

    input, select {
      width: 100%;
      padding: 12px 14px;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,0.2);
      background: rgba(255,255,255,0.08);
      color: #fff;
      font-size: 15px;
      font-family: 'Poppins', sans-serif;
      outline: none;
      backdrop-filter: blur(12px);
      box-shadow: 0 8px 32px rgba(0,0,0,0.2), 0 0 0 1px rgba(255,255,255,0.05);
      transition: all 0.3s ease;
    }

    input:focus, select:focus {
      border: 1px solid rgba(255,255,255,0.4);
      box-shadow: 0 8px 32px rgba(0,0,0,0.25), 0 0 15px rgba(255,255,255,0.15);
      backdrop-filter: blur(18px);
    }

    /* SELECT DROPDOWN STYLING */
    select {
      cursor: pointer;
    }

    select option {
      background: rgba(30, 30, 30, 0.95);
      color: #fff;
      padding: 10px;
    }

    select::-webkit-scrollbar {
      width: 8px;
    }

    select::-webkit-scrollbar-track {
      background: rgba(255,255,255,0.05);
    }

    select::-webkit-scrollbar-thumb {
      background: rgba(255,255,255,0.2);
      border-radius: 4px;
    }

    /* PRICE DISPLAY BOX */
    .price-display {
      background: rgba(255,255,255,0.1);
      border: 2px solid rgba(255,255,255,0.3);
      border-radius: 12px;
      padding: 15px 20px;
      margin: 20px 0;
      text-align: center;
      backdrop-filter: blur(12px);
    }

    .price-label {
      font-size: 12px;
      color: #aaa;
      margin-bottom: 5px;
      letter-spacing: 1px;
    }

    .price-amount {
      font-size: 32px;
      font-weight: 700;
      color: #fff;
      text-shadow: 0 0 10px rgba(255,255,255,0.5);
    }

    /* TERMS BOX */
    .terms-box {
      background: rgba(255, 255, 255, 0.05);
      border-radius: 16px;
      padding: 15px;
      margin-top: 25px;
      font-size: 13px;
      color: #bbb;
      text-align: left;
      line-height: 1.6;
      border: 1px solid rgba(255,255,255,0.1);
      backdrop-filter: blur(12px);
    }

    .terms-box strong { color: #fff; }

    /* CHECKBOX */
    .terms-check {
      margin-top: 15px;
    }

    .terms-check label {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 14px;
      color: #ddd;
      font-weight: 600;
      cursor: pointer;
      user-select: none;
    }

    .terms-check input[type="checkbox"] {
      appearance: none;
      -webkit-appearance: none;
      width: 22px;
      height: 22px;
      border-radius: 6px;
      border: 2px solid #888;
      background: rgba(255,255,255,0.1);
      cursor: pointer;
      transition: all 0.3s ease;
      display: inline-block;
      position: relative;
      vertical-align: middle;
      flex-shrink: 0;
    }

    .terms-check input[type="checkbox"]:checked {
      border-color: #fff;
      background: #fff;
    }

    .terms-check input[type="checkbox"]:checked::after {
      content: "‚úî";
      color: #000;
      font-size: 14px;
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      pointer-events: none;
    }

    /* BUTTONS */
    .submit-btn {
      width: 100%;
      padding: 14px;
      border: none;
      border-radius: 16px;
      background: rgba(255,255,255,0.08);
      color: #fff;
      font-weight: 600;
      font-size: 17px;
      cursor: pointer;
      transition: all 0.3s ease;
      margin-top: 15px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.25);
      backdrop-filter: blur(12px);
    }

    .submit-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      box-shadow: none;
    }

    .submit-btn:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 12px 40px rgba(0,0,0,0.35);
      backdrop-filter: blur(18px);
    }

    .back-btn {
      display: inline-block;
      margin-top: 25px;
      text-decoration: none;
      color: #aaa;
      font-weight: 500;
      font-size: 15px;
    }

    .back-btn:hover { color: #fff; }

    /* ‚úÖ MOBILE RESPONSIVE IMPROVEMENTS */
    @media (max-width: 768px) {
      .navbar {
        padding: 12px 20px;
      }

      .navbar img {
        height: 35px;
      }

      .navbar a span {
        font-size: 16px;
      }

      .container {
        padding: 30px 25px;
        margin-top: 40px;
      }

      h2 {
        font-size: 22px;
      }

      p {
        font-size: 14px;
      }

      .price-amount {
        font-size: 28px;
      }

      .terms-box {
        font-size: 12px;
        padding: 12px;
      }

      .terms-check label {
        font-size: 13px;
      }

      input, select {
        font-size: 14px;
        padding: 11px 12px;
      }

      .submit-btn {
        font-size: 16px;
        padding: 13px;
      }
    }

    @media (max-width: 480px) {
      .container {
        padding: 25px 20px;
        margin-top: 30px;
        width: 97%;
      }

      h2 {
        font-size: 20px;
      }

      .navbar {
        padding: 10px 15px;
      }

      .navbar img {
        height: 30px;
        margin-right: 8px;
      }

      label {
        font-size: 14px;
      }

      .price-display {
        padding: 12px 15px;
      }

      .price-amount {
        font-size: 26px;
      }

      .terms-box {
        font-size: 11px;
        line-height: 1.5;
      }

      .back-btn {
        font-size: 14px;
      }
    }
  </style>

</head>

<body>
  <div class="navbar">
    <a id="homeBtn" href="intelli.html">
      <img src="logo.png" alt="IntelliPark Logo">
      <span>INTELLIPARK</span>
    </a>
  </div>

  <div class="container">
    <h2>BOOK YOUR PARKING SPOT</h2>
    <p><strong>Selected Slot:</strong> <span id="selectedSlot" style="color: #fff; text-shadow: 0 0 5px rgba(255,255,255,0.3);"></span></p>

    <form id="bookingForm">
      <div class="form-group">
        <label for="name">NAME:</label>
        <input type="text" id="name" required>
      </div>

      <div class="form-group">
        <label for="email">EMAIL:</label>
        <input type="email" id="email" required>
      </div>

      <div class="form-group">
        <label for="plate">PLATE NUMBER:</label>
        <input type="text" id="plate" required placeholder="e.g., ABC123" pattern="^[A-Za-z]{3}[0-9]{3}$">
      </div>

      <div class="form-group">
        <label for="vehicle">VEHICLE TYPE:</label>
        <select id="vehicle" required>
          <option value="">-- Select Vehicle --</option>
          <option value="Car">Car (‚Ç±50)</option>
          <option value="Motorcycle">Motorcycle (‚Ç±30)</option>
        </select>
      </div>

      <!-- PRICE DISPLAY -->
      <div class="price-display" id="priceDisplay" style="display:none;">
        <div class="price-label">TOTAL AMOUNT</div>
        <div class="price-amount" id="priceAmount">‚Ç±0</div>
      </div>

      <div class="form-group">
        <label for="time">PARKING TIME:</label>
        <input type="time" id="time" required>
      </div>

      <div class="terms-box">
        By continuing to book, I authorize <strong>IntelliPark</strong> to collect and process my information, including my vehicle plate number, for parking verification, slot reservation, billing, and security monitoring in accordance with the Data Privacy Act of 2012. Unauthorized use of a reserved slot or exceeding the reserved time may result in vehicle clamping and applicable penalties.
      </div>

      <div class="terms-check">
        <label>
          <input type="checkbox" id="agreeTerms">
          I agree to the Terms and Conditions
        </label>
      </div>

      <button type="submit" class="submit-btn" id="reserveBtn" disabled>Reserve Now</button>
    </form>

    <a id="backHomeBtn" href="intelli.html" class="back-btn">‚Üê Back to Home</a>
  </div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>

  <script>
  const firebaseConfig = {
    apiKey: "AIzaSyAuH0ng67kSk0arMNOxujgIpnBVr0pwNWE",
    authDomain: "intellipark2025-327e9.firebaseapp.com",
    databaseURL: "https://intellipark2025-327e9-default-rtdb.firebaseio.com",
    projectId: "intellipark2025-327e9",
    storageBucket: "intellipark2025-327e9.appspot.com",
    messagingSenderId: "126333727252",
    appId: "1:126333727252:web:ffa87b61f5e7b3a2122d01"
  };

  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  const validSlots = ['slot01', 'slot02', 'slot03', 'slot04', 'slot05', 
                      'slot06', 'slot07', 'slot08', 'slot09', 'slot10'];

  const params = new URLSearchParams(window.location.search);
  const selectedSlot = params.get("slot");
  
  if (!selectedSlot || !validSlots.includes(selectedSlot)) {
    alert("Invalid or no slot selected. Redirecting...");
    window.location.href = "levels.html";
  }
  
  document.getElementById("selectedSlot").textContent = selectedSlot.toUpperCase();

  const form = document.getElementById("bookingForm");
  const timeInput = document.getElementById("time");
  const agreeTerms = document.getElementById("agreeTerms");
  const reserveBtn = document.getElementById("reserveBtn");
  const vehicleSelect = document.getElementById("vehicle");
  const priceDisplay = document.getElementById("priceDisplay");
  const priceAmount = document.getElementById("priceAmount");

  let selectedPrice = 0;
  vehicleSelect.addEventListener("change", () => {
    const vehicleType = vehicleSelect.value;
    
    if (vehicleType === "Motorcycle") {
      selectedPrice = 30;
      priceAmount.textContent = "‚Ç±30";
      priceDisplay.style.display = "block";
    } else if (vehicleType === "Car") {
      selectedPrice = 50;
      priceAmount.textContent = "‚Ç±50";
      priceDisplay.style.display = "block";
    } else {
      selectedPrice = 0;
      priceDisplay.style.display = "none";
    }
    
    console.log(`Selected: ${vehicleType} - ‚Ç±${selectedPrice}`);
  });

  agreeTerms.addEventListener("change", () => {
    reserveBtn.disabled = !agreeTerms.checked;
  });

  function normalize(date) {
    date.setSeconds(0);
    date.setMilliseconds(0);
    return date;
  }

  function setMinMaxTime() {
    const now = new Date();
    const hhMin = String(now.getHours()).padStart(2, "0");
    const mmMin = String(now.getMinutes()).padStart(2, "0");
    timeInput.min = `${hhMin}:${mmMin}`;
    now.setMinutes(now.getMinutes() + 120);
    const hhMax = String(now.getHours()).padStart(2, "0");
    const mmMax = String(now.getMinutes()).padStart(2, "0");
    timeInput.max = `${hhMax}:${mmMax}`;
  }
  document.addEventListener("DOMContentLoaded", setMinMaxTime);

  form.addEventListener("submit", async (e) => {
    e.preventDefault();
    if (!agreeTerms.checked) {
      alert("Please agree to the Terms and Conditions first.");
      return;
    }

    const name = document.getElementById("name").value.trim();
    const email = document.getElementById("email").value.trim();
    const plate = document.getElementById("plate").value.trim().toUpperCase();
    const vehicle = document.getElementById("vehicle").value;
    const time = document.getElementById("time").value;

    if (!vehicle) {
      alert("Please select a vehicle type.");
      return;
    }

    const platePattern = /^[A-Za-z]{3}[0-9]{3}$/;
    if (!platePattern.test(plate)) {
      alert("Plate format must be ABC123 (3 letters + 3 numbers).");
      return;
    }

    const now = normalize(new Date());
    const selectedTime = normalize(new Date());
    const [hh, mm] = time.split(":").map(Number);
    selectedTime.setHours(hh, mm, 0, 0);
    const maxTime = normalize(new Date());
    maxTime.setMinutes(maxTime.getMinutes() + 120);
    if (selectedTime < now) {
      alert("You cannot book in the past.");
      return;
    }
    if (selectedTime > maxTime) {
      alert("You cannot book more than 2 hours ahead.");
      return;
    }

    reserveBtn.disabled = true;
    reserveBtn.textContent = "Creating Invoice...";

    try {
      const slotSnapshot = await db.ref(`/${selectedSlot}`).get();
      
      if (!slotSnapshot.exists()) {
        alert(`Slot ${selectedSlot} does not exist in the system.`);
        window.location.href = "levels.html";
        return;
      }
      
      const slotData = slotSnapshot.val();
      if (slotData.status !== "Available") {
        alert(`Sorry, ${selectedSlot.toUpperCase()} is no longer available.`);
        window.location.href = "levels.html";
        return;
      }

      console.log("üì§ Sending to backend:", { 
        name, 
        email, 
        plate, 
        vehicle, 
        amount: selectedPrice, 
        time, 
        slot: selectedSlot 
      });

      const res = await fetch("https://intellipark-backend-ar00.onrender.com/api/create-invoice", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ 
          name, 
          email, 
          plate, 
          vehicle, 
          amount: selectedPrice,
          time, 
          slot: selectedSlot 
        })
      });

      console.log("üì• Response status:", res.status);

      if (!res.ok) {
        const errorText = await res.text();
        console.error("‚ùå Backend error:", errorText);
        throw new Error(`Server returned ${res.status}: ${errorText}`);
      }

      const result = await res.json();
      console.log("üì¶ Response data:", result);

      const invoiceUrl = result.invoice_url || result.invoiceUrl;
      
      if (invoiceUrl) {
        console.log("‚úÖ Redirecting to payment:", invoiceUrl);
        window.location.href = invoiceUrl;
      } else {
        console.error("‚ùå No invoice URL found in response:", result);
        throw new Error("No invoice URL received from server");
      }
    } catch (err) {
      console.error("‚ùå Full error:", err);
      alert("Failed to create invoice:\n\n" + err.message + "\n\nPlease try again.");
      
      reserveBtn.disabled = !agreeTerms.checked;
      reserveBtn.textContent = "Reserve Now";
    }
  });
</script>
</body>
</html>
