<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>IntelliPark Kiosk Start</title>
  <script src="https://unpkg.com/html5-qrcode"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
  <style>
    html, body {
      margin: 0;
      padding: 0;
      background: linear-gradient(180deg, #3b0066 0%, #7c00a5 50%, #cc44cc 100%);
      font-family: 'Segoe UI', sans-serif;
      color: white;
      height: 100vh;
      width: 100vw;
      overflow: hidden;
    }
    .header {
      background: #6e1f9c;
      padding: 4vh 0;
      text-align: center;
      font-size: 5vh;
      font-weight: bold;
      color: white;
      text-shadow: 0 0 20px #ffffffaa;
    }
    .tap-message {
      text-align: center;
      font-size: 5vh;
      font-weight: bold;
      color: white;
      text-shadow: 0 0 20px white, 0 0 30px white;
      margin: 2vh 0;
      font-family: 'Anton', sans-serif;
    }
    .main {
      display: flex;
      justify-content: space-around;
      align-items: center;
      height: 80vh;
      padding: 2vh 5vw;
      gap: 5vw;
      flex-wrap: wrap;
    }
    .policy-box {
      background: white;
      color: black;
      border-radius: 30px;
      padding: 30px;
      width: 45vw;
      max-width: 600px;
      font-size: 2.2vh;
      font-weight: bold;
      text-align: left;
      box-shadow: 0 0 20px navy;
      border: 10px solid navy;
    }
    .indicator-row {
      display: flex;
      justify-content: space-around;
      align-items: center;
      flex-wrap: wrap;
      margin: 2vh 0;
    }
    .indicator img { height: 60px; margin-bottom: 8px; }
    .scanner-wrapper {
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    .scanner-frame {
      width: 40vw;
      max-width: 320px;
      aspect-ratio: 1 / 1;
      border: 10px solid navy;
      border-radius: 20px;
      box-shadow: 0 0 20px navy;
      position: relative;
      overflow: hidden;
    }
    #reader {
      width: 100%;
      height: 100%;
      border-radius: 20px;
      object-fit: cover;
    }
    #reader video {
      width: 100% !important;
      height: 100% !important;
      object-fit: cover !important;
      border-radius: 20px !important;
    }
    #notification {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(0, 0, 0, 0.8);
      padding: 20px 30px;
      border-radius: 12px;
      font-size: 22px;
      font-weight: bold;
      color: white;
      display: none;
      z-index: 999;
    }
    #notification.success { background-color: #008000cc; }
    #notification.error { background-color: #cc0000cc; }
  </style>
</head>
<body onclick="proceed()">

  <div class="header">WELCOME TO INTELLIPARK!</div>
  <div class="tap-message">TAP ANYWHERE TO CHECK-IN WITHOUT QR</div>

  <div class="main">
    <div class="policy-box">
      <h2>POLICY AND GUIDELINES</h2>
      <div class="indicator-row">
        <div class="indicator">
          <img src="green.png" alt="Green" />
          <div>AVAILABLE SLOT<br><span style="color:green">GREEN LIGHT</span></div>
        </div>
        <div class="indicator">
          <img src="red.png" alt="Red" />
          <div>OCCUPIED SPOT<br><span style="color:red">RED LIGHT</span></div>
        </div>
        <div class="indicator">
          <img src="blue.png" alt="Blue" />
          <div>RESERVED SPOT<br><span style="color:blue">BLUE LIGHT</span></div>
        </div>
      </div>
      <div class="fines">
        <div>FINES:</div>
        <div>• LOST TICKET FINE: ₱500</div>
        <div>• UNAUTHORIZED USE OF RESERVED SPOT: ₱400</div>
      </div>
    </div>

    <div class="scanner-wrapper">
      <div class="scanner-frame">
        <div id="reader"></div>
      </div>
      <div class="qr-instruction">SCAN YOUR QR RESERVATION HERE</div>
    </div>
  </div>

  <div id="notification"></div>

  <audio id="successSound" src="success.mp3" preload="auto"></audio>
  <audio id="failSound" src="fail.mp3" preload="auto"></audio>
  <audio id="qrDetectedPrompt" src="scan_prompt.mp3" preload="auto"></audio>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyAuH0ng67kSk0arMNOxujgIpnBVr0pwNWE",
      authDomain: "intellipark2025-327e9.firebaseapp.com",
      databaseURL: "https://intellipark2025-327e9-default-rtdb.firebaseio.com",
      projectId: "intellipark2025-327e9",
      storageBucket: "intellipark2025-327e9.appspot.com",
      messagingSenderId: "126333727252",
      appId: "1:126333727252:web:ffa87b61f5e7b3a2122d01"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    const reader = new Html5Qrcode("reader");
    const notif = document.getElementById("notification");
    const successSound = document.getElementById("successSound");
    const failSound = document.getElementById("failSound");
    const qrDetectedPrompt = document.getElementById("qrDetectedPrompt");

    let scannedRecently = false;

    function showNotification(message, type = "success") {
      notif.textContent = message;
      notif.className = type;
      notif.style.display = "block";

      if (type === "success") successSound.play();
      else failSound.play();
    }

    function onScanSuccess(decodedText) {
      if (scannedRecently) return;
      scannedRecently = true;

      qrDetectedPrompt.play();
      reader.pause();

      try {
        const url = new URL(decodedText);
        const slot = url.searchParams.get("slot");
        const plate = url.searchParams.get("plate");
        const vehicle = url.searchParams.get("vehicle") || "N/A";
        const name = url.searchParams.get("name") || "KioskUser";
        const time = new Date().toLocaleTimeString();
        const timestamp = new Date().toISOString();

        if (!slot || !plate) return showNotification("❌ Invalid QR format", "error");

        db.ref(`/reservations/${slot}`).get().then(snapshot => {
          if (snapshot.exists() && snapshot.val().plate === plate) {
            // ✅ Keep status "Reserved"
            showNotification("✅ QR Verified! Redirecting…", "success");
            setTimeout(() => {
              window.location.href = `kiosk-receipt.html?slot=${slot}&name=${name}&plate=${plate}&vehicle=${vehicle}&time=${time}&timestamp=${encodeURIComponent(timestamp)}`;
            }, 2000);
          } else {
            showNotification("❌ No matching reservation", "error");
            scannedRecently = false;
            reader.resume();
          }
        });
      } catch (e) {
        console.error(e);
        showNotification("❌ Failed to read QR", "error");
        scannedRecently = false;
        reader.resume();
      }
    }

    function proceed() {
      window.location.href = "kiosk-vehicle.html";
    }

    window.onload = () => {
      reader.start({ facingMode: "user" }, { fps: 10, qrbox: 180 }, onScanSuccess)
        .catch(err => {
          console.error("Camera error:", err);
          showNotification("❌ Unable to access camera", "error");
        });
    };
  </script>
</body>
</html>
